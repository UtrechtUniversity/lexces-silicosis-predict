---
title: "Silicosis Diagnostic Rule"
subtitle: "Description of diagnostic rule and impact of misclassification error"
author: 
  - "Javier Mancilla Galindo, junior researcher"
  - "Dr. Susan Peters, Supervisor"
date: today
execute: 
  echo: false
  warning: false
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
  pdf: 
    toc: true
    documentclass: scrartcl
bibliography: ../docs/manuscript/lexces-silicosis-predict.bib
csl: ../docs/manuscript/american-medical-association.csl
editor: source
---

\pagebreak

# Setup

```{r}
#| include: false  

# Create directories for sub-folders  
inputfolder <- "../data/raw"
psfolder <- "../data/processed"
tempfolder <- "../data/temp"
figfolder <- "../results/output_figures"
tabfolder <- "../results/output_tables"

dir.create(inputfolder, showWarnings = FALSE)
dir.create(psfolder, showWarnings = FALSE)
dir.create(tempfolder, showWarnings = FALSE)
dir.create(figfolder, showWarnings = FALSE)
dir.create(tabfolder, showWarnings = FALSE)
```

## Packages used

```{r}
#| echo: true 

if (!require("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

pacman::p_load(
  tidyverse,  # Used for basic data handling and visualization.
  gt,         # Used to print html tables.  
  report      # Used to cite packages used in this session.   
)
```

\pagebreak

## Session and package dependencies

```{r}
#| echo: false  

# remove clutter
session <- sessionInfo()
session$BLAS <- NULL
session$LAPACK <- NULL
session$loadedOnly <- NULL
# write log file
writeLines(
  capture.output(print(session, locale = FALSE)),
  paste0("sessions/",lubridate::today(), "_session_Silicosis_diagnostic_rule.txt")
)                 

session
```

\pagebreak

# Description

A diagnostic prediction model to **rule out** pneumoconiosis in construction workers was developed and published in 2007.[@Suarthana2007] The study population consisted of Dutch natural stone and construction workers age 30 years and older. 

## Outcome

The diagnosis of pneumoconiosis was defined as a chest x ray (CXR) indicative for pneumoconiosis (ILO profusion category ≥1/1), for which the ILO international classification of radiographs of pneumoconioses 2000 version was used. The most up-to-date version of this guideline is the 2022 revised edition.[@ILO2022] The ILO score is assigned upon examination of small opacities on CXR, in comparison to standardized CXR images, and is composed of a major category, which is followed by a subcategory. For instance, a score of 1/0 means that 1 was assigned as the major category, while 0 was strongly considered as the alternative. Conversely, a score of 0/1 means that the radiologist assigned 0 as the major category, but strongly considered 0 as suitable. A score 1/1 means that the CXR is consistent with the standardized CXR graded as 1.

As mentioned earlier, an ILO score ≥1/1 was considered as the reference standard for pneumoconiosis to develop the prediction rule. This contrasts with standard recommendations at the time mentioning that an ILO category 1/0 or higher should be considered consistent with the presence of pneumoconiosis.[@Wagner1996] This decision was made under the rationale that a 1/0 cutoff would lead to greater misclassification. Furthermore, three different radiologists provided a score and the median score was used. Out of the 1291 workers included for analysis, a total of 37 (2.9%) had a score ≥1/1, whereas 131 (10.1%) were graded ≥1/0.

## Predictors

Lung function measured with a pneumotacometer on the same day of CXR obtention and worker questionnaire variables were assessed as potential predictors of pneumoconiosis. Seven candidate predictors were identified in univariable analysis:

-   Age
-   Smoking status
-   Job title
-   Time working in the construction industry
-   Feeling unhealthy
-   Cumulative exposure to silica index
-   Standardized residual FEV1

Continuous variables were dichotomized and modeled both as continuous and binary. Since there were no differences in the AUC of a prediction model with continuous vs binary predictores, the latter was kept for simplicity.

The final model included five predictors:

| Predictor                              | Value                   | Score | Beta |
|-----------------------|-----------------|-----------------|-----------------|
| Age                                    | ≥40 years               | 1.0   | 0.72 |
| Smoking habit                          | Current smoker          | 1.0   | 0.70 |
| Job title                              | High exposure job title | 1.5   | 1.14 |
| Work duration in construction industry | ≥15 years               | 1.5   | 1.00 |
| Self-related health                    | Feeling unhealthy       | 1.25  | 0.84 |
| Standardized residual FEV1             | ≤ -1.0                  | 1.25  | 0.91 |

## Diagnostic accuracy

The uncorrected AUC of the model was 0.81 (95%CI: 0.75 to 0.86). The corrected AUC was 0.76. A cutoff point of 3.75 is suggested as optimal, with the following classification measures:

|        | CXR + | CXR - |      |
|--------|-------|-------|------|
| Rule + | 33    | 534   | 567  |
| Rule - | 4     | 720   | 724  |
|        | 37    | 1254  | 1291 |

-   Sensitivity: 89.2%,
-   Specificity: 57.4%,
-   Negative Predictive Value: 99.4%,
-   Positive Predictive Value: 85.2%

\pagebreak

# Misclassification error of CXR

## CXR based on Meijer, et al.[@Meijer2011]

A subset of 180 participants enrolled in the study used for the development of the diagnostic prediction rule were invited for further examination with chest high resolution computed tomography (HRCT), of which a total of **n=79** participants underwent HRCT.[@Meijer2011] However, a final diagnosis of silicosis was not made based on HRCT and consensus by radiologists, and the study limited to report HRCT findings with their frequencies among different ILO thresholds.

## CXR based on ILO 1/0 cut-off from Hoy, et al.[@Hoy2024]

A recent study has estimated misclassification error of CXR using ILO categories against HRCT as the reference standard.[@Hoy2024] Using the standardized cut-off of 1/0, CXR diagnostic performance against HRCT was as follows:

|       | HRCT + | HRCT - |      |
|-------|--------|--------|------|
| CXR + | 25     | 2      | 27   |
| CXR - | 15     | 68     | 83   |
|       | 40     | 70     | 110  |

```{r}
TP <- 25 # True positives
TN <- 68 # True negatives 
FP <- 2  # False positives
FN <- 15 # False negatives 

Sn <- TP/(TP+FN)
Sp <- TN/(FP+TN)
FPR <- 1-Sp
PPV <- TP/(TP+FP)
NPV <- TN/(FN+TN)
LRpos <- Sn/(1-Sp)
LRneg <- (1-Sn)/Sp
Accuracy <- (TP+TN)/(TP+FP+FN+TN)
DOR <- (TP*TN)/(FP*FN)

cat("Sensitivity (%):", round((Sn*100),1), "\n")
cat("Specificity (%):", round((Sp*100),1), "\n")
cat("False Positive Rate (%):", round((FPR*100),1), "\n")
cat("Positive Predictive Value; (%):", round((PPV*100),1), "\n")
cat("Negative Predictive Value; (%):", round((NPV*100),1), "\n")
cat("Likelihood Ratio (+):", round(LRpos,2), "\n")
cat("Likelihood Ratio (-):", round(LRneg,2), "\n")
cat("Accuracy (%):", round((Accuracy*100),1), "\n")
cat("Diagnostic Odds Ratio:", round(DOR,2), "\n")
```

## CXR based on ILO 1/1 cut-off from Hoy, et al.[@Hoy2024]

Using the summary data reported by Hoy, et al.[@Hoy2024] for different ILO scores, a 2x2 table can be recreated for the 1/1 ILO threshold: 

|       | HRCT + | HRCT - |      |
|-------|--------|--------|------|
| CXR + | 23     | 2      | 27   |
| CXR - | 17     | 68     | 83   |
|       | 40     | 70     | 110  |

```{r}
TP <- 23 # True positives
TN <- 68 # True negatives 
FP <- 2  # False positives
FN <- 17 # False negatives 

Sn <- TP/(TP+FN)
Sp <- TN/(FP+TN)
FPR <- 1-Sp
PPV <- TP/(TP+FP)
NPV <- TN/(FN+TN)
LRpos <- Sn/(1-Sp)
LRneg <- (1-Sn)/Sp
Accuracy <- (TP+TN)/(TP+FP+FN+TN)
DOR <- (TP*TN)/(FP*FN)

cat("Sensitivity (%):", round((Sn*100),1), "\n")
cat("Specificity (%):", round((Sp*100),1), "\n")
cat("False Positive Rate (%):", round((FPR*100),1), "\n")
cat("Positive Predictive Value; (%):", round((PPV*100),1), "\n")
cat("Negative Predictive Value; (%):", round((NPV*100),1), "\n")
cat("Likelihood Ratio (+):", round(LRpos,2), "\n")
cat("Likelihood Ratio (-):", round(LRneg,2), "\n")
cat("Accuracy (%):", round((Accuracy*100),1), "\n")
cat("Diagnostic Odds Ratio:", round(DOR,2), "\n")
```

\pagebreak

# Accounting for misclassification error

Corrected ROC curve analysis of prediction models can be done by taking into account misclassification error for binary outcomes, provided that disease prevalence and misclassification rates are known.[@Zawistowski2017]


```{r}
#| echo: true
source("scripts/Zawistowski_misclassification_functions.R")
```

```{r}
#| echo: true
#| eval: false
source("scripts/Diagnostic_rule_AUC_misclassification.R")
```

## Results 

### Main prediction model (ILO 1/1),[@Suarthana2007] misclassification based on ILO 1/0 by Hoy, et al.[@Hoy2024]

```{r}
ROC_results <- read.csv(paste0(tabfolder,"/ROC_results_ILO1-1_Suarthana2007__ILO1-1_Hoy2024.csv"))

table_results <- data.frame(
  Outcome = c("True", "Misclassified"),
  Mean = c(
    round(mean(ROC_results$ROC_true),3), 
    round(mean(ROC_results$ROC_misclassified),3)
    ),
  Median = c(
    round(median(ROC_results$ROC_true),3), 
    round(median(ROC_results$ROC_misclassified),3)
    ),
  Q1 = c(
    round(quantile(ROC_results$ROC_true,0.25),3), 
    round(quantile(ROC_results$ROC_misclassified,0.25),3)
    ),
  Q3 = c(
    round(quantile(ROC_results$ROC_true,0.75),3), 
    round(quantile(ROC_results$ROC_misclassified,0.75),3)
    ),
  Min = c(
    round(min(ROC_results$ROC_true),3), 
    round(min(ROC_results$ROC_misclassified),3)
    ),
  Max = c(
    round(max(ROC_results$ROC_true),3), 
    round(max(ROC_results$ROC_misclassified),3)
    )  
)

table_results %>% gt
```

```{r}
bias_absolute <- table_results$Mean[1] - table_results$Mean[2]

cat("Absolute difference in AUC:", bias_absolute, "\n") 
```

\pagebreak


# References

```{r}
#| include: false

# Run this chunk if you wish to clear your environment.
rm(list = ls())
```
